---
layout: default
id: Forwarding
title: 匹配转发
---

## 匹配转发

让我们从前面的示例中更仔细地看一下route属性和签名对：

```rust
#[get("/hello/<name>/<age>/<cool>")]
fn hello(name: String, age: u8, cool: bool) -> String { ... }
```

如果 `cool` 不是 `bool`怎么办？或者，如果 `age` 不是 `u8` 怎么办？当参数类型发生不匹配时，Rocket将请求转发到下一个匹配的路由（如果有）。这将一直持续，直到路由没有转发请求或没有剩余的路由可供尝试。如果没有剩余的路由，则返回可自定义的404错误。

路由尝试以递增的顺序进行。Rocket选择一个从-6到-1的默认排名，在下一节中将详细介绍，但是也可以使用rank属性手动设置路由的排名。为了说明这一点，请参考以下路由：

```rust
#[get("/user/<id>")]
fn user(id: usize) -> T { ... }

#[get("/user/<id>", rank = 2)]
fn user_int(id: isize) -> T { ... }

#[get("/user/<id>", rank = 3)]
fn user_str(id: &RawStr) -> T { ... }

fn main() {
    rocket::ignite()
        .mount("/", routes![user, user_int, user_str])
        .launch();
}
```

可以看到在函数`user_int`和`user_str`都设置了`rank`参数。如果我们把这几个路由挂载到根路径下，运行程序之后，向`/user/`的请求，会按照以下的规则去匹配：

1. 该`user`路线首先匹配。如果该`<id>`位置的字符串是无符号整数，则将调用`user`处理程序。如果不是，则将请求转发到下一个匹配的路由：`user_int`。
2. 用户输入的路由与下一个匹配。如果`<id>`是有符号整数，则调用`user_int`。否则，请求将被转发。
3. 用户路径最后匹配。因为`<id>`总是一个字符串，所以路由总是匹配的。调用`user_str`处理程序。

### 注：在启动过程中，一条路由的等级显示在[括号]中。

在应用程序启动期间，您还可以在方括号中找到路由的排名：`GET/user/<id>[3]（user_str）`。

可以使用 `Result` 或 `Option` 类型捕获转发。例如，如果用户函数中的`id`类型是`Result<usize，&RawStr>`，则`user`永远不会转发。`Ok`表示`<id>`是有效的`usize`，而`Err`表示`<id>`不是`usize`。`Err`的值应该包含无法解析为`usize`的字符串。

### 提示：不仅转发可以被捕获！

通常，当任何防护措施由于任何原因而失败时，包括参数防护措施，都可以在其位置使用`Option`或`Result`键入以捕获失败。

顺便说一句，如果您要去掉`user_str`或`user_int`路由中的`rank`参数，Rocket将会发出错误并中止启动，表明路由*发生冲突*，或者可以与相似的传入请求匹配。`rank`参数可解决此冲突。

### 默认排序

如果未明确指定等级，则Rocket会分配默认等级。默认情况下，具有静态路径和查询字符串的路由具有较低的等级（较高的优先级），而具有动态路径和没有查询字符串的路由具有较高的等级（较低的优先级）。下表根据给定的属性描述了路由的默认排序。

| 静态路径 | 查询参数（query) | rank | 例子                |
| -------- | ---------------- | ---- | ------------------- |
| 是       | 部分静态         | -6   | `/hello?world=true` |
| 是       | 完全动态         | -5   | `/hello/?<world>`   |
| 是       | 无               | -4   | `/hello`            |
| 否       | 部分静态         | -3   | `/<hi>?world=true`  |
| 否       | 完全动态         | -2   | `/<hi>?<world>`     |
| 否       | 无               | -1   | `/<hi>`             |